<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>OpenSim Documentation : Getting Started with RRA</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            OpenSim Documentation : Getting Started with RRA
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Jan 30, 2012 by <font color="#0050B2">jenhicks</font>.
				    </div>
                    <p>The topics covered in this section include:</p><p><div>
<ul>
    <li><a href='#GettingStartedwithRRA-SettingsFile'>Settings File</a></li>
    <li><a href='#GettingStartedwithRRA-Inputs'>Inputs</a></li>
    <li><a href='#GettingStartedwithRRA-Outputs'>Outputs</a></li>
    <li><a href='#GettingStartedwithRRA-BestPracticesandTroubleshooting'>Best Practices and Troubleshooting</a></li>
</ul></div></p><p>Below is a conceptual review of the inputs and outputs of the Residual Reduction Algorithm (RRA) along with a set of troubleshooting tips and best practices for completing the tool. </p><p>The residual reduction algorithm tool is accessed by selecting <strong>Tools → Residual Reduction Algorithm…</strong> from the OpenSim main menu bar. Like all tools, the operations performed by the computed muscle control tool apply to the current model.</p><p>The figure below shows the required inputs and outputs for performing the residual reduction algorithm. Each is described in more detail below.</p><p><img class="confluence-embedded-image confluence-external-resource" height="153" width="533" src="attachments/1443223/1900769.png" data-image-src="http://simtk-confluence.stanford.edu:8080/download/attachments/1443223/worddav6d93d8ccc3dc25cae8e4d5f1d72241b5.png?version=1&amp;modificationDate=1322501682833"></p><p><strong>Figure</strong><strong>: Inputs and Outputs for performing residual reduction.</strong> Experimental data are shown in <span style="color: rgb(0,204,153);">green</span>; OpenSim files (.osim) are shown in <span style="color: rgb(165,0,33);">red</span>; settings files are shown in <span style="color: rgb(51,102,255);">blue</span>; files generated by the workflow are shown in <span style="color: rgb(153,51,255);">purple</span>.</p><h2 id="GettingStartedwithRRA-SettingsFile">Settings File</h2><p>The <span style="color: rgb(51,102,255);"><strong>subject01_Setup_RRA.xml</strong></span> file is a setup file for the RRATool, which specifies settings, inputs, and outputs that affect the behavior of the residual reduction algorithm, which can be defined using the GUI or by hand. Details of the settings are described in the section on using the <a href="http://simtk-confluence.stanford.edu:8080/display/OpenSim/Graphical+User+Interface">Graphical User Interface</a>.</p><p>The setup file identifies the actuators (i.e., the ideal residual and reserve joint actuators required by RRA) as well as the kinematic tracking tasks. Furthermore, control constraints on the actuators (to limit the maximum residual force) can be specified.</p><h2 id="GettingStartedwithRRA-Inputs">Inputs</h2><p>Several files are required as input to the RRA Tool to perform residual reduction:</p><p><span style="color: rgb(153,51,255);"><strong>subject01_walk1_ik.mot</strong></span>: Contains the time histories of model kinematics including the joint angles and pelvis translations.</p><p><span style="color: rgb(51,102,255);"><strong>gait2345_RRA_Tasks.xml</strong></span>: A tracking tasks file specifying which coordinates to track and the corresponding tracking weight (weights are relative and determine how &quot;well&quot; a joint angle will track the specified joint angle from IK). A couple key considerations:</p><ol><li>Selection of kp and kv are not arbitrary. They define the behavior of the error dynamics for each q as a second order linear system. We can write the kp and kv for the desired system behavior in terms of system poles. For a (stable) critically damped system (real negative poles) kp = lambda^2 and kv = -2*lambda.</li><li>This enables kinematics of joints (coordinates) for which we have high confidence (e.g. knee flexion, hip flexion) to be weighted more heavily compared to those of less confidence (e.g. hip internal rotation and ankle inversion). </li></ol><p><span style="color: rgb(51,102,255);"><strong>gait2345_RRA_ControlConstraints.xml</strong></span>: Contains limits on the RRA actuators. The actuator constraints file specifying the maximum and minimum &quot;excitation&quot; (i.e., control signal) for each actuator. A few key considerations:</p><ol><li>Note that the maximum/minimum force or torque generated by an ideal actuator is the product of the max/min force and max/min excitation.</li><li>Joint torques (and muscles) have a maximum magnitude of 1.</li><li>Residuals have bounds exceeding their anticipated force requirement. Weightings are implicit in this description. A high optimal_force means that large output force (torque) does not require a large control value (i.e. low cost). Conversely, residuals with low optimal force require high control values that incur higher costs. </li></ol><p><span style="color: rgb(0,204,153);"><strong>subject01_walk1_grf.xml</strong></span>: ExternalLoads file specifying the measured ground reaction forces that should be applied to the model during simulation and how to apply them. </p><p><span style="color: rgb(165,0,33);"><strong>subject01_simbody.osim</strong></span>: A subject-specific OpenSim model generated by scaling a generic model with the Scale Tool or by other means, along with an associated marker set containing adjusted virtual markers. The model must include inertial parameters.</p><p><span style="color: rgb(51,102,255);"><strong>gait2345_RRA_Actuators.xml</strong></span>: Ideal joint actuators used to replace muscles. The Actuator Set specifies the residual and reserve actuators to be applied and their parameters, like maximum/minimum force and body or joint, or location, depending on the actuator type. A few key considerations:</p><ol><li>Each degree of freedom in the model should have an ideal torque or force (reserve) actuator. This includes the 6 DOFs of the model's base segment, which are called the residual actuators. </li><li>In most circumstances, these Ideal joint actuators used to replace the muscles in the model (by checking &quot;Replace model actuators&quot; in the Actuators tab.  </li><li>Optimal forces are the maximum output of ideal actuators (torques, linear forces). Torque (force) applied is optimal_force x control_value</li><li>Residual at pelvis should be applied at scaled location of COM</li></ol><h2 id="GettingStartedwithRRA-Outputs">Outputs</h2><p>Residual reduction generates the following outputs:</p><p><strong><span style="color: rgb(102,0,102);">subject01_RRA_states.sto</span></strong>: Adjusted kinematics (i.e., joint angles) and corresponding model states of the simulated motion (i.e., joint angles AND velocities).</p><p><span style="color: rgb(128,0,0);"><strong>subject01_adjusted.osim</strong></span> (optional): A model with adjusted mass properties.</p><p><strong><span style="color: rgb(102,0,102);">subject01_RRA_forces.sto</span></strong><span style="color: rgb(0,0,255);">:</span> Actuator forces and torques (i.e., joint torques corresponding to adjusted kinematics).</p><p><strong><span style="color: rgb(102,0,102);">subjcet01_RRA_controls.xml</span></strong><span style="color: rgb(0,0,255);">:</span> Actuator excitations (i.e., control signals needed to generate actuator forces and torques)</p><h2 id="GettingStartedwithRRA-BestPracticesandTroubleshooting">Best Practices and Troubleshooting</h2><p><ol><li>Some first troubleshooting steps:<ol><li>Check the pelvis COM location in Actuator files</li><li>“Lock” the subtalar and mtp joints in *.osim file</li><li>Make sure “use_fast_optimization_target” is false (unchecked) </li><li><p>Make sure “cmc_time_window” is 0.001 s for RRA</p></li></ol></li><li>RMS difference in joint angle during the movement should be less than 2-5º (or less than 2 cm for translations).</li><li>Peak Residual Forces should be less than 10-20 N.</li><li>Compare the residual moments from RRA to the moments from Inverse Dynamics. You should see a 30-50% reduction in peak residual moments.</li><li>Compare the joint torques/forces to established literature (if available). Try to find data with multiple subjects. Your results should be within one standard deviation of the literature.</li><li>Optimal forces for residuals should be low to prevent the optimizer from &quot;wanting&quot; to use residual actuators (an actuator with large optimal force and low excitation is &quot;cheap&quot; in the optimizer cost).</li><li>To help minimize residuals, make an initial pass with default inputs, then check residuals and coordinate errors. To reduce residuals further, decrease tracking weights on coordinates with low error. You can also try decreasing the maximum excitation on residuals or the actuator optimal force. </li><li>If RRA is failing, try increasing the max excitation for residuals by 10x until the simulation runs. Then try working your way back down while also &quot;relaxing&quot; tracking weights on coordinates. </li><li>If residuals are very large (typically, this is greater than 2-3x BW, depending on the motion), there is probably something wrong with either i) the scaled model, (ii) the IK solution, or (iii) the applied GRFs.  To double check that forces are being applied properly, visualize GRFs with IK data (you can use the &quot;Preview motion data&quot; function in the GUI).</li></ol></p><div class="panel" style="background-color: white;border-color: gray;border-style: solid;border-width: 5px;"><div class="panelContent" style="background-color: white;">
<p>Next: <a href="http://simtk-confluence.stanford.edu:8080/display/OpenSim/How+RRA+Works">How RRA Works</a></p><p>Home: <a href="http://simtk-confluence.stanford.edu:8080/display/OpenSim/Residual+Reduction+Algorithm">Residual Reduction Algorithm</a></p>
</div></div>
				    
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://simtk-confluence.stanford.edu:8080/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Feb 02, 2012 10:52</font></td>
		    </tr>
	    </table>
    </body>
</html>
